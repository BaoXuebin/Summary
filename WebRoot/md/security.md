# 安全认证接口

安全认证接口中，主要封装了机关、部门、用户、权限等接口对象，以及获取和验证机关、部门、用户、权限的接口方法。安全认证接口在com.wondersgroup.esf.security包中。

各项目在实现业务功能模块的过程中，应基于安全认证接口开发，不必关注接口的实现。

安全认证接口的实现，根据具体项目分两种情况：

+ 如果项目使用本框架的应用支撑平台实现功能，包括组织结构管理、用户管理、权限管理、身份认证，那么安全认证接口将由框架中的应用支撑功能来实现。
+ 如果项目自己实现应用支撑功能，或者采用第三方应用支撑功能，那么需要在框架之外实现安全认证接口。

### 安全登陆逻辑

应用系统的安全登录逻辑如下：

![安全登陆逻辑](../image/security-1.png "安全登陆逻辑")

1. 根据用户登录机制验证用户身份有效性，如果验证不通过，登录失败。如果通过单点登录的机制实现，那么通过所用单点登录产品的验证机制获取用户身份信息；如果通过独立的用户名和密码机制实现，那么用户名和密码的数据库验证机制验证用户身份信息；
2. 根据部门编号从数据库获取用户部门信息，以及部门所属机关信息，如果获取不到，或者获取的是无效部门，登录失败；
3. 根据需要进行双因素认证，比如CA认证，如果验证不通过，登录失败；
4. 获取用户该应用系统的权限信息，如果用户没有该系统的权限，登录失败；
5. 记录登录成功审计日志；
6. 打开应用主界面：
  1. 根据app.properties中图片配置，展示页面banner部位的logo图片和应用系统图片
  2. 展示登录用户姓名、单位、部门信息
  3. 根据个人设置，展示用户个性化的快捷菜单、界面肤色等信息
  4. 根据app.properties中的链接配置，展示应用系统个性链接
  5. 根据登录用户权限，展示左侧菜单
  6. 根据应用系统配置中的主操作区默认页面URL，在主操作区展示相关页面
  7. 根据app.properties中的配置，展示脚注区文字信息
  8. 根据app.properties中的应用编号配置，展示应用版本信息
6. 登录完成。

### 安全认证过滤器

本框架定义了一个安全认证过滤器com.wondersgroup.esf.security.controller.EsfLoginFilter，对所有控制层*.do请求进行过滤处理，判断用户登录情况。

用户的身份认证实际上是在这个过滤器中实现的。如果过滤器发现用户尚未登录，那么会截获请求中的用户登录信息，进行单点登录或独立登录的逻辑处理。如果登录成功，会将用户信息、用户所属机关信息、用户所属部门信息、用户权限信息保存到session中。如果登录失败，那么会转到错误页面。

### 接口说明

#### bo接口

| 类名  |说明 |
| :- | :-------: |
|IUser	|用户基本信息只读接口。|
|IOrgan	|机关基本信息只读接口。|
|IDept	|部门基本信息只读接口。|
|IMenu	|菜单信息只读接口。|
|IAppInfo	|应用软件基本信息只读接口|

#### ISecurityService接口

安全认证包中的业务层接口对象为ISecurityService业务层实现类，其中封装了组织、用户、权限的获取和验证等方法。主要方法如下表：

|方法|说明|
| :- | :-------: |
|logon (String)	|根据用户编号登录，适用于单点登录的情况。或获取不到，或者获取的用户无效，抛异常。|
|logon (String, String)	|根据用户登录名和密码登录，适用于独立登录的情况。如获取不到或者获取到多于一个有效用户，抛异常。如密码错误，抛异常。|
|getOrganByCode(String)	|根据组织代码取得组织信息。如不存在，抛异常。|
|getOrganById(String)	|根据机关编号取得机关信息，获取不到则抛异常。|
|getOrganByCode(String)	|根据机关内部代码取得有效机关信息，如获取不到有效机关，或者获取到超过一个有效机关，则抛异常。|
|getDeptById(String)	|根据部门编号取得部门信息，获取不到则抛异常。|
|getDeptByCode(String)	|根据部门代码取得有效部门信息，如获取不到有效部门，或者获取到超过一个有效部门，则抛异常。|
|getMainDeptByUser(String)	|取得用户主要部门IDept对象。|
|getDeptListByUser(String)	|取得用户所属部门列表。|
|getUserListByDeptId(String, boolean)	|根据部门编号，获取部门下的用户列表，第二个参数表示是否同时获取子部门用户。|
|getUserListByOrganId (String, boolean)	|根据机关编号，获取机关下的用户列表，第二个参数表示是否同时获取下级机关用户。|
|getParentDept(String)	|取得部门的上级部门，如没有则返回null。|
|getOrganByDept(String)|	取得部门所属机关IOrgan对象。|
|getParentOrgan(String)	|取得机关的上级机关，如没有则返回null。|
|getPermissionIdListByUser (String, String)	|根据用户编号和应用代码，获取用户在某个应用中的权限编号列表。|
|getMenuListByUser (String, String)	|根据用户编号和应用代码，获取用户在某个应用中的菜单列表。|
|getAppInfoByCode(String)	|根据应用软件编号获取应用软件信息，取不到则抛异常。|

